# 审计日志管理功能实施方案

## 一、需求分析

### 1.1 功能目标

在现有的"日志管理"一级菜单下，添加基于 ABP 框架审计功能的日志管理页面，用于查看和管理`AbpAuditLogs`和`AbpAuditLogActions`数据表中的审计日志信息。

### 1.2 数据表结构

- **AbpAuditLogs**：记录每个 HTTP 请求的审计信息
  - 主要字段：执行时间、持续时间、用户信息、客户端 IP、HTTP 方法、URL、状态码、异常信息等
- **AbpAuditLogActions**：记录每个请求中执行的具体操作
  - 主要字段：服务名称、方法名称、执行时间、参数、返回值等
  - 与 AbpAuditLogs 是一对多关系（通过 AuditLogId 关联）

### 1.3 页面设计方案选择

**推荐方案：单页面设计（主从视图）**

**理由：**

1. **数据关联性强**：审计日志和操作日志是主从关系，在一个页面中展示更直观
2. **用户体验好**：用户可以在查看审计日志列表的同时，点击展开查看关联的操作日志，无需页面跳转
3. **与现有风格一致**：与现有的"运行日志"页面风格保持一致
4. **开发效率高**：减少页面跳转逻辑，降低开发复杂度

**页面布局：**

- 上半部分：审计日志列表（主表）
- 下半部分：选中审计日志的操作详情（从表，可折叠展开）

## 二、技术方案

### 2.1 数据访问方式

#### 方案 A：直接使用 DbContext（推荐）

- 通过`IDbContextProvider<PaperBellStoreDbContext>`访问审计日志表
- 优点：简单直接，性能好
- 缺点：需要手动处理查询逻辑

#### 方案 B：使用 ABP 的审计日志服务

- 通过`IAuditLogRepository`访问（如果 ABP 提供了该接口）
- 优点：符合 ABP 规范，可能有额外的业务逻辑
- 缺点：需要确认 ABP 是否提供了该接口

**推荐使用方案 A**，因为 ABP 的审计日志表是标准的 EF Core 实体，直接使用 DbContext 更灵活。

### 2.2 实体类型

ABP 框架的审计日志实体类型：

- `Volo.Abp.AuditLogging.AuditLog` - 审计日志主表
- `Volo.Abp.AuditLogging.AuditLogAction` - 审计日志操作表

### 2.3 页面功能需求

#### 2.3.1 审计日志列表功能

- ✅ 分页显示审计日志列表
- ✅ 按执行时间排序（默认降序）
- ✅ 过滤功能：
  - 按时间范围过滤（开始时间、结束时间）
  - 按用户名过滤
  - 按 HTTP 方法过滤（GET、POST、PUT、DELETE 等）
  - 按 HTTP 状态码过滤
  - 按 URL 关键词搜索
  - 按客户端 IP 过滤
  - 仅显示有异常的日志
- ✅ 自动过滤框架相关日志：默认隐藏包含 "Volo.Abp" 的审计日志和操作（可配置）
- ✅ 显示关键信息：
  - 执行时间
  - 系统标签（标识系统级别的操作）
  - 用户名
  - HTTP 方法
  - URL
  - 状态码（带颜色标识：2xx 绿色、3xx 蓝色、4xx 黄色、5xx 红色）
  - 执行时长（毫秒）
  - 客户端 IP
  - 是否有异常（图标标识）

#### 2.3.2 操作日志详情功能

- ✅ 点击审计日志行，展开显示该审计日志关联的所有操作
- ✅ 操作列表显示：
  - 系统标签（标识系统级别的操作）
  - 服务名称
  - 方法名称
  - 执行时间
  - 执行时长
  - 参数（JSON 格式，可展开/折叠）
- ✅ 自动过滤框架相关操作：默认隐藏包含 "Volo.Abp" 的操作（可配置）
- ✅ 支持查看完整的审计日志详情（对话框形式）：
  - 基本信息（用户、时间、IP 等）
  - HTTP 请求信息
  - 浏览器信息
  - 异常信息（如果有）
  - 所有关联的操作列表

## 三、实施步骤

### 3.1 创建菜单项

**文件：`src/PaperBellStore.Blazor/Menus/PaperBellStoreMenus.cs`**

```csharp
public const string AuditLog = Prefix + ".AuditLog";
```

**文件：`src/PaperBellStore.Blazor/Menus/PaperBellStoreMenuContributor.cs`**
在`logTestManagement`下添加审计日志菜单项：

```csharp
logTestManagement.AddItem(new ApplicationMenuItem(
    PaperBellStoreMenus.AuditLog,
    l["Menu:AuditLog"],
    "/audit-log",
    icon: "fas fa-shield-alt"
));
```

### 3.2 添加本地化资源

**文件：`src/PaperBellStore.Domain.Shared/Localization/PaperBellStore/zh-Hans.json`**

```json
"Menu:AuditLog": "审计日志"
```

**文件：`src/PaperBellStore.Domain.Shared/Localization/PaperBellStore/en.json`**

```json
"Menu:AuditLog": "Audit Log"
```

### 3.3 创建审计日志页面组件

**文件：`src/PaperBellStore.Blazor/Components/Pages/AuditLog.razor`**

- 使用 MudBlazor 组件库
- 参考`RunningLog.razor`的布局风格
- 实现主从视图布局

**文件：`src/PaperBellStore.Blazor/Components/Pages/AuditLog.razor.cs`**

- 继承`BreadcrumbComponentBase`
- 注入`IDbContextProvider<PaperBellStoreDbContext>`
- 实现数据查询、过滤、分页逻辑

### 3.4 创建审计日志详情对话框组件

**文件：`src/PaperBellStore.Blazor/Components/AuditLogDetailDialog.razor`**

- 显示审计日志的完整信息
- 使用 MudBlazor 的 Dialog 组件
- 格式化显示 JSON 数据

### 3.5 数据库查询优化

- 为常用查询字段添加索引（ABP 框架已自动创建）
- 使用`AsNoTracking()`提升查询性能
- 实现合理的分页大小（建议 20-50 条/页）

## 四、详细设计

### 4.1 页面布局结构

```
┌─────────────────────────────────────────────────┐
│  过滤和搜索区域                                  │
│  [时间范围] [用户名] [HTTP方法] [状态码] [URL]  │
│  [搜索按钮] [重置按钮]                           │
├─────────────────────────────────────────────────┤
│  审计日志列表（主表）                            │
│  ┌──────────────────────────────────────────┐  │
│  │ 时间 | 用户 | 方法 | URL | 状态 | 时长  │  │
│  │ [展开] 查看详情                          │  │
│  └──────────────────────────────────────────┘  │
│  [分页控件]                                     │
├─────────────────────────────────────────────────┤
│  操作日志详情（从表，可折叠）                    │
│  ┌──────────────────────────────────────────┐  │
│  │ 服务名称 | 方法名称 | 执行时间 | 参数    │  │
│  └──────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
```

### 4.2 数据模型

#### 审计日志 DTO（用于页面显示）

```csharp
public class AuditLogDto
{
    public Guid Id { get; set; }
    public DateTime ExecutionTime { get; set; }
    public int ExecutionDuration { get; set; }
    public string? UserName { get; set; }
    public string? HttpMethod { get; set; }
    public string? Url { get; set; }
    public int? HttpStatusCode { get; set; }
    public string? ClientIpAddress { get; set; }
    public bool HasException { get; set; }
    public string? Exceptions { get; set; }
    public List<AuditLogActionDto> Actions { get; set; } = new();
}
```

#### 操作日志 DTO

```csharp
public class AuditLogActionDto
{
    public Guid Id { get; set; }
    public string? ServiceName { get; set; }
    public string? MethodName { get; set; }
    public DateTime ExecutionTime { get; set; }
    public int ExecutionDuration { get; set; }
    public string? Parameters { get; set; }
    public string? ReturnValue { get; set; }
}
```

### 4.3 查询逻辑

```csharp
// 查询审计日志
var query = dbContext.Set<AuditLog>()
    .AsNoTracking()
    .AsQueryable();

// 时间范围过滤
if (startDate.HasValue)
    query = query.Where(x => x.ExecutionTime >= startDate.Value);
if (endDate.HasValue)
    query = query.Where(x => x.ExecutionTime <= endDate.Value);

// 用户名过滤
if (!string.IsNullOrEmpty(userName))
    query = query.Where(x => x.UserName.Contains(userName));

// HTTP方法过滤
if (!string.IsNullOrEmpty(httpMethod))
    query = query.Where(x => x.HttpMethod == httpMethod);

// 状态码过滤
if (httpStatusCode.HasValue)
    query = query.Where(x => x.HttpStatusCode == httpStatusCode.Value);

// URL搜索
if (!string.IsNullOrEmpty(urlKeyword))
    query = query.Where(x => x.Url != null && x.Url.Contains(urlKeyword));

// 仅显示异常
if (onlyExceptions)
    query = query.Where(x => !string.IsNullOrEmpty(x.Exceptions));

// 排序和分页
var auditLogs = await query
    .OrderByDescending(x => x.ExecutionTime)
    .Skip((currentPage - 1) * pageSize)
    .Take(pageSize)
    .ToListAsync();

// 查询关联的操作日志
var auditLogIds = auditLogs.Select(x => x.Id).ToList();
var actions = await dbContext.Set<AuditLogAction>()
    .AsNoTracking()
    .Where(x => auditLogIds.Contains(x.AuditLogId))
    .ToListAsync();
```

## 五、实施建议

### 5.1 开发优先级

1. **第一阶段**：基础功能

   - 创建菜单项和页面路由
   - 实现基本的审计日志列表展示
   - 实现分页功能

2. **第二阶段**：过滤和搜索

   - 实现时间范围过滤
   - 实现用户名、HTTP 方法、状态码过滤
   - 实现 URL 关键词搜索

3. **第三阶段**：详情展示

   - 实现操作日志详情展开/折叠
   - 实现审计日志详情对话框
   - 优化 JSON 数据展示

4. **第四阶段**：优化和测试
   - 性能优化
   - UI/UX 优化
   - 单元测试和集成测试

### 5.2 注意事项

1. **性能考虑**

   - 审计日志表数据量可能很大，必须实现分页
   - 使用`AsNoTracking()`提升查询性能
   - 考虑添加缓存（可选）

2. **数据安全**

   - 审计日志可能包含敏感信息，需要权限控制
   - 建议添加权限检查：`[Authorize(Permissions = "AuditLog.View")]`

3. **用户体验**

   - 大数据量查询时显示加载状态
   - 提供友好的错误提示
   - JSON 数据格式化显示，支持展开/折叠

4. **兼容性**
   - 确保与现有"运行日志"页面的风格一致
   - 使用相同的面包屑导航机制

## 六、替代方案：双页面设计

如果选择双页面设计，需要创建两个页面：

1. **审计日志列表页面**（`/audit-log`）

   - 显示审计日志列表
   - 点击某条日志，导航到详情页面

2. **审计日志详情页面**（`/audit-log/{id}`）
   - 显示单条审计日志的完整信息
   - 显示该审计日志关联的所有操作

**双页面设计的优缺点：**

**优点：**

- 页面职责更清晰
- 可以更详细地展示单条日志信息
- URL 可以分享，便于定位特定日志

**缺点：**

- 需要页面跳转，用户体验稍差
- 开发工作量增加（需要处理路由参数）
- 与现有单页面风格不一致

**建议：优先使用单页面设计，如果后续发现单页面无法满足需求，再考虑拆分为双页面。**

## 七、过滤和系统标签功能

### 7.1 框架相关日志过滤

为了保持审计日志列表的简洁性，默认情况下会自动过滤掉 ABP 框架相关的审计日志和操作。

#### 7.1.1 过滤逻辑

**审计日志过滤：**

- 过滤条件：URL 包含 "Volo.Abp" 的审计日志将被隐藏
- 实现位置：`AuditLog.razor.cs` 的 `LoadAuditLogs()` 方法

```csharp
// 过滤掉包含 Volo.Abp 的条目（框架相关的审计日志）
query = query.Where(x => x.Url == null || !x.Url.Contains("Volo.Abp"));
```

**操作日志过滤：**

- 过滤条件：服务名称包含 "Volo.Abp" 的操作将被隐藏
- 实现位置：
  - `AuditLog.razor.cs` 的 `LoadAuditLogActions()` 方法
  - `AuditLog.razor.cs` 的 `ShowAuditLogDetail()` 方法
  - `AuditLogDetailDialog.razor` 的 `FilteredActions` 属性

```csharp
// 过滤掉包含 Volo.Abp 的操作（框架相关的操作）
.Where(x => x.ServiceName == null || !x.ServiceName.Contains("Volo.Abp"))
```

#### 7.1.2 移除过滤的步骤

如果需要显示所有审计日志（包括框架相关的），可以按照以下步骤操作：

**步骤 1：移除审计日志列表的过滤**

在 `src/PaperBellStore.Blazor/Components/Pages/AuditLog.razor.cs` 文件中，找到 `LoadAuditLogs()` 方法，注释或删除以下代码：

```csharp
// 注释或删除这行代码
// query = query.Where(x => x.Url == null || !x.Url.Contains("Volo.Abp"));
```

**步骤 2：移除操作日志的过滤**

在 `src/PaperBellStore.Blazor/Components/Pages/AuditLog.razor.cs` 文件中：

1. 在 `LoadAuditLogActions()` 方法中，注释或删除：

```csharp
// 注释或删除这行代码
// .Where(x => x.ServiceName == null || !x.ServiceName.Contains("Volo.Abp"))
```

2. 在 `ShowAuditLogDetail()` 方法中，注释或删除：

```csharp
// 注释或删除这行代码
// .Where(x => x.ServiceName == null || !x.ServiceName.Contains("Volo.Abp"))
```

**步骤 3：移除详情对话框的过滤**

在 `src/PaperBellStore.Blazor/Components/Pages/AuditLogDetailDialog.razor` 文件中：

1. 修改 `FilteredActions` 属性，直接返回 `Actions`：

```csharp
// 修改前
private List<Volo.Abp.AuditLogging.AuditLogAction>? FilteredActions =>
    Actions?.Where(x => x.ServiceName == null || !x.ServiceName.Contains("Volo.Abp")).ToList();

// 修改后
private List<Volo.Abp.AuditLogging.AuditLogAction>? FilteredActions => Actions;
```

2. 或者将 `FilteredActions` 的使用改为 `Actions`：

```razor
<!-- 修改前 -->
<MudDataGrid Items="@FilteredActions" ...>

<!-- 修改后 -->
<MudDataGrid Items="@Actions" ...>
```

**步骤 4：重新编译和测试**

完成修改后，重新编译项目并测试，确认所有审计日志（包括框架相关的）都能正常显示。

### 7.2 系统标签功能

系统标签用于标识系统级别的操作，帮助用户快速识别哪些是框架或系统内部的操作。

#### 7.2.1 系统操作判断逻辑

系统操作的判断基于服务名称或 URL 中的关键词，当前判断的关键词包括：

- `System`
- `Microsoft`
- `Internal`
- `Framework`

实现位置：`AuditLog.razor.cs` 的 `IsSystemOperation()` 方法

```csharp
/// <summary>
/// 判断是否为系统操作
/// </summary>
private bool IsSystemOperation(string? serviceNameOrUrl)
{
    if (string.IsNullOrEmpty(serviceNameOrUrl))
        return false;

    // 判断是否为系统级别的操作
    // 可以根据需要扩展判断逻辑
    var systemKeywords = new[] { "System", "Microsoft", "Internal", "Framework" };
    return systemKeywords.Any(keyword =>
        serviceNameOrUrl.Contains(keyword, StringComparison.OrdinalIgnoreCase));
}
```

#### 7.2.2 自定义系统标签判断逻辑

如果需要修改系统标签的判断逻辑，可以：

1. **添加新的关键词**：在 `systemKeywords` 数组中添加新的关键词
2. **修改判断规则**：可以改为使用正则表达式或其他更复杂的判断逻辑
3. **基于命名空间判断**：可以根据命名空间前缀判断（如 `System.*`、`Microsoft.*` 等）

**示例：基于命名空间判断**

```csharp
private bool IsSystemOperation(string? serviceNameOrUrl)
{
    if (string.IsNullOrEmpty(serviceNameOrUrl))
        return false;

    // 基于命名空间前缀判断
    var systemNamespaces = new[] { "System.", "Microsoft.", "Internal.", "Framework." };
    return systemNamespaces.Any(ns =>
        serviceNameOrUrl.StartsWith(ns, StringComparison.OrdinalIgnoreCase));
}
```

#### 7.2.3 系统标签显示位置

系统标签在以下位置显示：

1. **审计日志列表**：位于"执行时间"列之后，显示为深色边框的标签，带计算机图标
2. **操作日志详情**：位于表格最前面，同样显示为深色边框的标签
3. **详情对话框**：在操作列表标签页中显示

标签样式：

- 颜色：深色（`Color.Dark`）
- 样式：边框样式（`Variant.Outlined`）
- 图标：计算机图标（`Icons.Material.Filled.Computer`）
- 文本："系统"

#### 7.2.4 移除系统标签

如果不需要显示系统标签，可以：

1. **移除列定义**：在 `AuditLog.razor` 中删除系统标签的 `TemplateColumn`
2. **移除 DTO 属性**：在 `AuditLogDto` 和 `AuditLogActionDto` 中删除 `IsSystem` 属性
3. **移除判断逻辑**：删除 `IsSystemOperation()` 方法及其调用

### 7.3 配置化过滤（可选扩展）

如果需要更灵活的过滤配置，可以考虑：

1. **配置文件方式**：在 `appsettings.json` 中配置需要过滤的关键词
2. **用户设置方式**：允许用户在界面上选择是否显示框架相关的日志
3. **权限控制方式**：根据用户权限决定是否显示框架相关的日志

**示例：配置文件方式**

```json
{
  "AuditLog": {
    "Filter": {
      "ExcludeKeywords": ["Volo.Abp", "System.", "Microsoft."],
      "ShowSystemLogs": false
    }
  }
}
```

## 八、总结

本方案推荐使用**单页面设计（主从视图）**，在一个页面中同时展示审计日志列表和操作日志详情。这种设计既保持了与现有"运行日志"页面的一致性，又提供了良好的用户体验。

实施过程中，建议分阶段开发，先实现基础功能，再逐步完善过滤、搜索和详情展示功能。同时需要注意性能优化和数据安全。

**新增功能总结：**

1. ✅ **框架日志过滤**：默认隐藏包含 "Volo.Abp" 的审计日志和操作，保持列表简洁
2. ✅ **系统标签**：自动识别并标记系统级别的操作，便于快速识别
3. ✅ **可配置性**：提供了详细的移除过滤和自定义判断逻辑的步骤
