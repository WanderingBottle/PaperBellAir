# 数据库日志定期清理功能实现说明

## 📋 概述

已实现基于 Hangfire 的数据库日志定期清理功能，可以自动清理过期的日志记录，防止数据库无限增长。

## ✅ 已实现的功能

### 1. 日志清理任务类

**文件位置**：`src/PaperBellStore.Blazor/RecurringJobs/LogCleanupRecurringJob.cs`

**功能特点**：
- ✅ 支持按日志级别设置不同的保留天数
- ✅ 支持配置默认保留天数
- ✅ 支持启用/禁用清理功能
- ✅ 详细的清理统计信息记录
- ✅ 异常处理和自动重试（Hangfire 自动处理）
- ✅ 使用 ABP 的 UnitOfWork 确保数据一致性

### 2. 定时任务注册

**文件位置**：`src/PaperBellStore.Blazor/PaperBellStoreBlazorModule.cs`

**执行时间**：每天凌晨 2:00 自动执行

**任务ID**：`log-cleanup-daily`

### 3. 配置项

**文件位置**：`src/PaperBellStore.Blazor/appsettings.json`

```json
{
  "Serilog": {
    "Database": {
      "Cleanup": {
        "Enabled": true,                    // 是否启用清理功能
        "DefaultRetentionDays": 30,         // 默认保留天数（其他级别）
        "ErrorRetentionDays": 90,           // Error 级别保留 90 天
        "WarningRetentionDays": 60,         // Warning 级别保留 60 天
        "InformationRetentionDays": 30,    // Information 级别保留 30 天
        "DebugRetentionDays": 7             // Debug 级别保留 7 天
      }
    }
  }
}
```

## 🔧 配置说明

### 保留天数策略

| 日志级别 | 默认保留天数 | 说明 |
|---------|------------|------|
| Error | 90 天 | 错误日志保留时间最长，便于问题排查 |
| Warning | 60 天 | 警告日志保留中等时间 |
| Information | 30 天 | 信息日志保留标准时间 |
| Debug | 7 天 | 调试日志保留时间最短 |
| Verbose | 7 天 | 详细日志与 Debug 使用相同策略 |
| 其他/空 | 30 天 | 使用默认保留天数 |

### 清理逻辑

1. **时间判断**：优先使用 `LastOccurrence` 字段（如果存在），否则使用 `Timestamp` 字段
2. **级别过滤**：按日志级别分别清理，确保不同级别使用不同的保留策略
3. **批量删除**：使用 EF Core 的批量删除功能，提高性能
4. **事务保证**：使用 ABP 的 UnitOfWork 确保数据一致性

## 📊 清理统计

每次清理任务执行后，会记录详细的统计信息：

```
日志清理任务完成。删除记录数：150，耗时：2.35秒
级别 Error：删除 5 条记录（保留天数：90）
级别 Warning：删除 20 条记录（保留天数：60）
级别 Information：删除 100 条记录（保留天数：30）
级别 Debug：删除 25 条记录（保留天数：7）
```

## 🚀 使用方法

### 1. 启动应用

启动应用后，Hangfire 会自动注册定时任务。任务会在每天凌晨 2:00 执行。

### 2. 查看任务状态

访问 Hangfire Dashboard：`https://localhost:44305/hangfire`

在 "Recurring jobs" 页面可以看到 `log-cleanup-daily` 任务：
- 任务ID：`log-cleanup-daily`
- Cron 表达式：`0 2 * * *`（每天凌晨 2:00）
- 最后执行时间
- 下次执行时间

### 3. 手动触发清理

如果需要立即执行清理任务，可以通过 Hangfire Dashboard：
1. 访问 `/hangfire`
2. 找到 `log-cleanup-daily` 任务
3. 点击 "Trigger now" 按钮

### 4. 修改执行时间

如果需要修改执行时间，编辑 `PaperBellStoreBlazorModule.cs` 中的 `RegisterRecurringJobs` 方法：

```csharp
RecurringJob.AddOrUpdate<RecurringJobs.LogCleanupRecurringJob>(
    "log-cleanup-daily",
    job => job.ExecuteAsync(),
    Cron.Daily(3, 0),  // 修改为每天凌晨 3:00
    new RecurringJobOptions
    {
        TimeZone = TimeZoneInfo.Local
    });
```

### 5. 禁用清理功能

在 `appsettings.json` 中设置：

```json
{
  "Serilog": {
    "Database": {
      "Cleanup": {
        "Enabled": false
      }
    }
  }
}
```

## ⚙️ 高级配置

### 修改保留天数

根据实际需求，可以在 `appsettings.json` 中调整各级别的保留天数：

```json
{
  "Serilog": {
    "Database": {
      "Cleanup": {
        "ErrorRetentionDays": 180,      // Error 保留 6 个月
        "WarningRetentionDays": 90,     // Warning 保留 3 个月
        "InformationRetentionDays": 60, // Information 保留 2 个月
        "DebugRetentionDays": 14        // Debug 保留 2 周
      }
    }
  }
}
```

### 修改执行频率

如果需要更频繁的清理（例如每天执行多次），可以修改 Cron 表达式：

```csharp
// 每天执行 2 次：凌晨 2:00 和下午 14:00
RecurringJob.AddOrUpdate<RecurringJobs.LogCleanupRecurringJob>(
    "log-cleanup-daily",
    job => job.ExecuteAsync(),
    "0 2,14 * * *",  // 自定义 Cron 表达式
    new RecurringJobOptions
    {
        TimeZone = TimeZoneInfo.Local
    });
```

## 📝 注意事项

1. **首次执行**：任务会在应用启动后，根据 Cron 表达式自动执行
2. **时区设置**：任务使用本地时区（`TimeZoneInfo.Local`）
3. **性能考虑**：清理任务在凌晨执行，避免影响业务高峰期
4. **数据安全**：清理操作不可逆，请根据实际需求设置合理的保留天数
5. **监控建议**：建议定期检查清理任务的执行日志，确保任务正常运行

## 🔍 故障排查

### 任务未执行

1. 检查 Hangfire Dashboard，确认任务已注册
2. 检查 Hangfire Server 是否正常运行
3. 查看应用日志，确认是否有错误信息

### 清理数量异常

1. 检查配置的保留天数是否合理
2. 检查数据库中的日志时间戳是否正确
3. 查看清理任务的执行日志，确认清理逻辑

### 性能问题

如果清理任务执行时间过长：
1. 考虑增加执行频率（例如每天执行 2 次）
2. 考虑分批删除（当前实现已使用批量删除）
3. 检查数据库索引是否正常（`IX_AppLogs_Timestamp` 和 `IX_AppLogs_Level`）

## 📚 相关文档

- [Hangfire 实施步骤.md](./Hangfire实施步骤.md)
- [Serilog数据库集成实施方案.md](./Serilog数据库集成实施方案.md)

---

**最后更新**：2024年

