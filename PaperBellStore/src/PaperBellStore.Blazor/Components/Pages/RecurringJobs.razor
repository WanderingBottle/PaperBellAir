@page "/hangfire-recurring-jobs"
@using System.Net.Http.Json
@using Blazorise
@using Blazorise.Components
@using Blazorise.DataGrid
@using PaperBellStore.Blazor.Components
@using PaperBellStore.Blazor.Services
@inherits BreadcrumbComponentBase

<PageTitle>@L["RecurringJobs:Title"]</PageTitle>

<PageBreadcrumb BreadcrumbId="@BreadcrumbId" HomeMenu="@HomeMenu" ParentMenu="@ParentMenu" CurrentMenu="@CurrentMenu" />

<div class="recurring-jobs-page mt-4">
	<Row>
		<Column>
			<Card>
				<CardHeader>
					<CardTitle>
						<Icon Name="IconName.Clock" />
						@L["RecurringJobs:Title"]
					</CardTitle>
					<CardActions>
						<Button Color="Color.Primary" Clicked="RefreshJobs" Disabled="@isLoading">
							<Icon Name="IconName.Sync" />
							@L["RecurringJobs:Refresh"]
						</Button>
						<Button Color="Color.Info" Clicked="NavigateToDashboard">
							<Icon Name="IconName.Forward" />
							@L["RecurringJobs:OpenDashboard"]
						</Button>
					</CardActions>
				</CardHeader>
				<CardBody>
					@if (!string.IsNullOrEmpty(lastError))
					{
						<Alert Color="Color.Danger">
							<strong>@L["RecurringJobs:LoadFailedTitle"]</strong> @lastError
						</Alert>
					}
					else
					{
						<Alert Color="Color.Light">
							@L["RecurringJobs:CurrentTaskCount", lastCount]
						</Alert>
					}

					<DataGrid TItem="RecurringJobDto" Data="@recurringJobs" Hoverable="true" Striped="true"
						ShowPager="false" Class="recurring-job-grid">
						<EmptyTemplate>
							<Text>@L["RecurringJobs:NoJobs"]</Text>
						</EmptyTemplate>
						<DataGridColumns>
							<DataGridColumn TItem="RecurringJobDto" Field="@nameof(RecurringJobDto.Id)"
								Caption="@L["RecurringJobs:ColumnId"]" />
							<DataGridColumn TItem="RecurringJobDto" Field="@nameof(RecurringJobDto.Cron)"
								Caption="@L["RecurringJobs:ColumnCron"]" Width="220px" />
							<DataGridColumn TItem="RecurringJobDto" Field="@nameof(RecurringJobDto.TimeZoneId)"
								Caption="@L["RecurringJobs:ColumnTimeZone"]" Width="220px" />
							<DataGridColumn TItem="RecurringJobDto" Field="@nameof(RecurringJobDto.NextExecution)"
								Caption="@L["RecurringJobs:ColumnNextExecution"]" Width="190px">
								<DisplayTemplate>
									<Text>@(context.NextExecution?.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss") ??
																				"-")</Text>
								</DisplayTemplate>
							</DataGridColumn>
							<DataGridColumn TItem="RecurringJobDto" Field="@nameof(RecurringJobDto.LastExecution)"
								Caption="@L["RecurringJobs:ColumnLastExecution"]" Width="190px">
								<DisplayTemplate>
									<Text>@(context.LastExecution?.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss") ??
																				"-")</Text>
																			</DisplayTemplate>
																		</DataGridColumn>
																		<DataGridColumn TItem="RecurringJobDto" Caption="@L["RecurringJobs:ColumnStatus"]"
																			Width="110px">
																			<DisplayTemplate>
																				<Badge Color="@(context.IsPaused? Color.Warning: Color.Success)" Pill="true">
										@(context.IsPaused ? L["RecurringJobs:StatusPaused"] :
																				L["RecurringJobs:StatusRunning"])
									</Badge>
								</DisplayTemplate>
							</DataGridColumn>
							<DataGridColumn TItem="RecurringJobDto" Caption="@L["RecurringJobs:ColumnActions"]"
								Width="240px">
								<DisplayTemplate>
									@if (canTrigger || canEdit || canDelete)
									{
										<Buttons Size="Size.Small">
											@if (canTrigger)
											{
												<Button Color="Color.Primary" Disabled="@(isLoading || context.IsPaused)"
													Clicked="@(async () => await TriggerJob(context.Id))">
													<Icon Name="IconName.Bolt" />
													@L["RecurringJobs:TriggerNow"]
												</Button>
											}

											@if (canEdit)
											{
												if (context.IsPaused)
												{
													<Button Color="Color.Success" Disabled="@isLoading"
														Clicked="@(async () => await ResumeJob(context.Id))">
														<Icon Name="IconName.Play" />
														@L["RecurringJobs:Resume"]
													</Button>
												}
												else
												{
													<Button Color="Color.Warning" Disabled="@isLoading"
														Clicked="@(async () => await PauseJob(context.Id))">
														<Icon Name="IconName.Pause" />
														@L["RecurringJobs:Pause"]
													</Button>
												}
											}

											@if (canDelete)
											{
												<Button Color="Color.Danger" Disabled="@isLoading"
													Clicked="@(async () => await DeleteJob(context.Id))">
													<Icon Name="IconName.Times" />
													@L["RecurringJobs:Delete"]
												</Button>
											}
										</Buttons>
									}
									else
									{
										<Text>@L["RecurringJobs:NoActions"]</Text>
									}
								</DisplayTemplate>
							</DataGridColumn>
						</DataGridColumns>
					</DataGrid>
				</CardBody>
			</Card>
		</Column>
	</Row>
</div>
