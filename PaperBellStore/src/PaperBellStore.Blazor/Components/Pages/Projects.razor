@page "/projects"
@using ProjectManage.Projects
@using Volo.Abp.Application.Dtos
@using System.Threading
@using MudBlazor
@inject IProjectAppService ProjectAppService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@rendermode InteractiveServer


<MudPaper Class="pa-4">
	<MudText Typo="Typo.h5" GutterBottom="true">项目管理</MudText>
	<MudTextField @bind-Value="_search" Placeholder="搜索项目..." Adornment="Adornment.Start" Immediate="true"
		OnBlur="OnSearchChanged" />
	<MudButton Color="MudBlazor.Color.Primary" Variant="Variant.Filled" OnClick="ShowAddDialogAsync">新增项目</MudButton>
	<MudTable @ref="_table" Items="_projects" ServerData="LoadServerData" Filterable="false" Hover="true"
		Bordered="true" Striped="true" Class="mt-2">
		<HeaderContent>
			<MudTh>项目名称</MudTh>
			<MudTh>描述</MudTh>
			<MudTh>状态</MudTh>
			<MudTh>开始</MudTh>
			<MudTh>结束</MudTh>
			<MudTh>负责人</MudTh>
			<MudTh>操作</MudTh>
		</HeaderContent>
		<RowTemplate>
			<MudTd DataLabel="项目名称">@context.Name</MudTd>
			<MudTd DataLabel="描述">@context.Description</MudTd>
			<MudTd DataLabel="状态">@context.Status.ToString()</MudTd>
			<MudTd DataLabel="开始">@context.StartDate.ToShortDateString()</MudTd>
			<MudTd DataLabel="结束">@context.EndDate?.ToShortDateString()</MudTd>
			<MudTd DataLabel="负责人">@context.OwnerName</MudTd>
			<MudTd DataLabel="操作">
				<MudButton Variant="Variant.Text" OnClick="@(() => ShowEditDialogAsync(context))">编辑</MudButton>
				<MudButton Variant="Variant.Text" Color="MudBlazor.Color.Error" OnClick="@(() => Delete(context.Id))">
					删除
				</MudButton>
			</MudTd>
		</RowTemplate>
		<PagerContent>
			<MudTablePager />
		</PagerContent>
	</MudTable>
</MudPaper>

@code {
	private MudTable<ProjectDto> _table;
	private List<ProjectDto> _projects = new();
	private string _search = string.Empty;
	private int _totalCount = 0;

	private async void OnSearchChanged()
	{
		await Refresh();
	}

	private async Task<TableData<ProjectDto>> LoadServerData(TableState state, CancellationToken cancellationToken)
	{
		var req = new GetProjectListDto
		{
			Filter = _search,
			SkipCount = state.Page * state.PageSize,
			MaxResultCount = state.PageSize,
			Sorting = "CreationTime DESC"
		};
		var result = await ProjectAppService.GetListAsync(req);
		_projects = result.Items.ToList();
		_totalCount = (int)result.TotalCount;
		return new TableData<ProjectDto> { Items = _projects, TotalItems = _totalCount };
	}

	private async Task ShowAddDialogAsync()
	{
		var editing = new CreateUpdateProjectDto { StartDate = DateTime.Now };
		var parameters = new DialogParameters
		{
			[nameof(ProjectDialog.Model)] = editing,
			[nameof(ProjectDialog.StartDate)] = editing.StartDate,
			[nameof(ProjectDialog.EndDate)] = editing.EndDate,
			[nameof(ProjectDialog.IsEdit)] = false
		};

		var options = new DialogOptions
		{
			CloseOnEscapeKey = true,
			MaxWidth = MaxWidth.Medium,
			FullWidth = true
		};

		var dialog = await DialogService.ShowAsync<ProjectDialog>("新增项目", parameters, options);
		var result = await dialog.Result;

		if (result != null && !result.Canceled && result.Data != null)
		{
			if (result.Data is ProjectDialog.ProjectDialogResult dialogResult)
			{
				dialogResult.Model.StartDate = dialogResult.StartDate;
				dialogResult.Model.EndDate = dialogResult.EndDate;
				await ProjectAppService.CreateAsync(dialogResult.Model);
				Snackbar.Add("创建成功", Severity.Success);
				await Refresh();
			}
		}
	}

	private async Task ShowEditDialogAsync(ProjectDto dto)
	{
		var editing = new CreateUpdateProjectDto
		{
			Name = dto.Name,
			Description = dto.Description,
			StartDate = dto.StartDate,
			EndDate = dto.EndDate,
			Status = dto.Status,
			OwnerId = dto.OwnerId
		};

		var parameters = new DialogParameters
		{
			[nameof(ProjectDialog.Model)] = editing,
			[nameof(ProjectDialog.StartDate)] = dto.StartDate,
			[nameof(ProjectDialog.EndDate)] = dto.EndDate,
			[nameof(ProjectDialog.IsEdit)] = true,
			[nameof(ProjectDialog.ProjectId)] = dto.Id
		};

		var options = new DialogOptions
		{
			CloseOnEscapeKey = true,
			MaxWidth = MaxWidth.Medium,
			FullWidth = true
		};

		var dialog = await DialogService.ShowAsync<ProjectDialog>("编辑项目", parameters, options);
		var result = await dialog.Result;

		if (result != null && !result.Canceled && result.Data != null)
		{
			if (result.Data is ProjectDialog.ProjectDialogResult dialogResult)
			{
				dialogResult.Model.StartDate = dialogResult.StartDate;
				dialogResult.Model.EndDate = dialogResult.EndDate;
				await ProjectAppService.UpdateAsync(dto.Id, dialogResult.Model);
				Snackbar.Add("更新成功", Severity.Success);
				await Refresh();
			}
		}
	}

	private async Task Delete(Guid id)
	{
		bool confirmed = await Task.FromResult(true); // TODO: 实现二次确认弹窗
		if (confirmed)
		{
			await ProjectAppService.DeleteAsync(id);
			Snackbar.Add("删除成功", Severity.Success);
			await Refresh();
		}
	}

	private async Task Refresh()
	{
		if (_table != null)
		{
			await _table.ReloadServerData();
		}
		await InvokeAsync(StateHasChanged);
	}
}
