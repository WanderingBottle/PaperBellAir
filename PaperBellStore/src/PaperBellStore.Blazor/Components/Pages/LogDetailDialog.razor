@using PaperBellStore.Data

<ModalContent Size="@Size" Class="log-detail-modal" Style="max-width: 60vw; width: 56vw;">
	<ModalHeader>
		<ModalTitle>日志详情</ModalTitle>
	</ModalHeader>
	<ModalBody Style="overflow-x: hidden !important; word-wrap: break-word !important; word-break: break-all !important; max-width: 100% !important;">
		<Row>
			<Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
				<Text><strong>时间:</strong> @Log.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</Text>
			</Column>
			<Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
				<Text><strong>级别:</strong></Text>
				<Badge Color="@GetLevelColor(Log.Level)">@Log.Level</Badge>
			</Column>
			<Column ColumnSize="ColumnSize.Is12" Style="max-width: 100%; overflow: hidden;">
				<Text><strong>消息:</strong></Text>
				<Card Style="max-width: 100% !important; overflow: hidden !important;">
					<CardBody Style="max-height: 200px; overflow-y: auto !important; overflow-x: hidden !important; word-wrap: break-word !important; word-break: break-all !important; max-width: 100% !important; box-sizing: border-box !important;">
						<div Style="white-space: pre-wrap !important; word-wrap: break-word !important; word-break: break-all !important; overflow-wrap: break-word !important; max-width: 100% !important;">
							@Log.Message
						</div>
					</CardBody>
				</Card>
			</Column>
			@if(!string.IsNullOrEmpty(Log.Exception))
			{
				<Column ColumnSize="ColumnSize.Is12" Style="max-width: 100%; overflow: hidden;">
					<Text><strong>异常信息:</strong></Text>
					<Card Style="max-width: 100% !important; overflow: hidden !important;">
						<CardBody Style="max-height: 200px; overflow-y: auto !important; overflow-x: hidden !important; font-family: monospace; font-size: 0.9em; word-wrap: break-word !important; word-break: break-all !important; max-width: 100% !important; box-sizing: border-box !important;">
							<div Style="white-space: pre-wrap !important; word-wrap: break-word !important; word-break: break-all !important; overflow-wrap: break-word !important; margin: 0; max-width: 100% !important;">
								@Log.Exception
							</div>
						</CardBody>
					</Card>
				</Column>
			}
			@if(Log.OccurrenceCount>1)
			{
				<Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
					<Text><strong>首次出现:</strong> @Log.FirstOccurrence?.ToString("yyyy-MM-dd HH:mm:ss")</Text>
				</Column>
				<Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
					<Text><strong>最后出现:</strong> @Log.LastOccurrence?.ToString("yyyy-MM-dd HH:mm:ss")</Text>
				</Column>
				<Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
					<Text><strong>出现次数:</strong></Text>
					<Badge Color="Color.Warning" Pill="true">
						@Log.OccurrenceCount 次
					</Badge>
				</Column>
			}
			@if(!string.IsNullOrEmpty(Log.Properties))
			{
				<Column ColumnSize="ColumnSize.Is12" Style="max-width: 100%; overflow: hidden;">
					<Text><strong>属性 (JSON):</strong></Text>
					<Card Style="max-width: 100% !important; overflow: hidden !important;">
						<CardBody Style="max-height: 200px; overflow-y: auto !important; overflow-x: hidden !important; font-family: monospace; font-size: 0.9em; word-wrap: break-word !important; word-break: break-all !important; max-width: 100% !important; box-sizing: border-box !important;">
							<div Style="white-space: pre-wrap !important; word-wrap: break-word !important; word-break: break-all !important; overflow-wrap: break-word !important; margin: 0; max-width: 100% !important;">
								@Log.Properties
							</div>
						</CardBody>
					</Card>
				</Column>
			}
			@if(!string.IsNullOrEmpty(Log.LogEvent))
			{
				<Column ColumnSize="ColumnSize.Is12" Style="max-width: 100%; overflow: hidden;">
					<Text><strong>日志事件 (JSON):</strong></Text>
					<Card Style="max-width: 100% !important; overflow: hidden !important;">
						<CardBody Style="max-height: 200px; overflow-y: auto !important; overflow-x: hidden !important; font-family: monospace; font-size: 0.9em; word-wrap: break-word !important; word-break: break-all !important; max-width: 100% !important; box-sizing: border-box !important;">
							<div Style="white-space: pre-wrap !important; word-wrap: break-word !important; word-break: break-all !important; overflow-wrap: break-word !important; margin: 0; max-width: 100% !important;">
								@Log.LogEvent
							</div>
						</CardBody>
					</Card>
				</Column>
			}
		</Row>
	</ModalBody>
	<ModalFooter>
		<Button Color="Color.Secondary" Clicked="@Cancel">关闭</Button>
	</ModalFooter>
</ModalContent>

@code {
	[CascadingParameter] protected ModalInstance ModalInstance { get; set; } = default!;

	[Inject] protected IModalService ModalService { get; set; } = default!;

	[Parameter]
	public AppLog Log { get; set; } = default!;

	[Parameter]
	public ModalSize Size { get; set; } = ModalSize.Default;

	private async Task Cancel()
	{
		if(ModalInstance!=null&&ModalService!=null)
		{
			await ModalService.Hide(ModalInstance);
		}
	}

	private Color GetLevelColor(string? level)
	{
		return level switch
		{
			"Verbose" => Color.Secondary,
			"Debug" => Color.Info,
			"Information" => Color.Primary,
			"Warning" => Color.Warning,
			"Error" => Color.Danger,
			"Fatal" => Color.Dark,
			_ => Color.Secondary
		};
	}
}
