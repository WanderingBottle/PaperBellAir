@page "/running-log"
@using PaperBellStore.Blazor.Services
@using MudBlazor
@using PaperBellStore.Data
@inherits BreadcrumbComponentBase
@implements IAsyncDisposable

<PageTitle>运行日志</PageTitle>

<PageBreadcrumb BreadcrumbId="@BreadcrumbId" HomeMenu="@HomeMenu" ParentMenu="@ParentMenu" CurrentMenu="@CurrentMenu" />

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
	<MudCard Elevation="3">
		<MudCardContent>
			@* 过滤和搜索区域 *@
			<MudText Typo="Typo.h5" Class="mb-4">
				<MudIcon Icon="@Icons.Material.Filled.Filter" Size="@MudBlazor.Size.Small" Class="mr-2" />
				过滤和搜索
			</MudText>

			<MudGrid Spacing="3">
				<MudItem xs="12" sm="6" md="3">
					<MudSelect T="string" @bind-Value="selectedLevel" Label="日志级别" Variant="Variant.Outlined" Clearable>
						<MudSelectItem T="string" Value="@((string?)null)">全部</MudSelectItem>
						<MudSelectItem T="string" Value="@("Verbose")">Verbose</MudSelectItem>
						<MudSelectItem T="string" Value="@("Debug")">Debug</MudSelectItem>
						<MudSelectItem T="string" Value="@("Information")">Information</MudSelectItem>
						<MudSelectItem T="string" Value="@("Warning")">Warning</MudSelectItem>
						<MudSelectItem T="string" Value="@("Error")">Error</MudSelectItem>
						<MudSelectItem T="string" Value="@("Fatal")">Fatal</MudSelectItem>
					</MudSelect>
				</MudItem>
				<MudItem xs="12" sm="6" md="3">
					<MudDatePicker @bind-Date="startDate" Label="开始时间" Variant="Variant.Outlined"
						DateFormat="yyyy-MM-dd HH:mm" TimeEditable="true" />
				</MudItem>
				<MudItem xs="12" sm="6" md="3">
					<MudDatePicker @bind-Date="endDate" Label="结束时间" Variant="Variant.Outlined"
						DateFormat="yyyy-MM-dd HH:mm" TimeEditable="true" />
				</MudItem>
				<MudItem xs="12" sm="6" md="3">
					<MudTextField @bind-Value="searchText" Label="搜索消息" Variant="Variant.Outlined"
						Placeholder="搜索日志消息..." Adornment="Adornment.Start"
						AdornmentIcon="@Icons.Material.Filled.Search" />
				</MudItem>
			</MudGrid>

			<MudStack Row="true" Spacing="2" Class="mt-3">
				<MudButton Variant="Variant.Outlined" Color="@MudBlazor.Color.Secondary"
					StartIcon="@Icons.Material.Filled.Refresh" OnClick="ResetFilters">
					重置过滤
				</MudButton>
				<MudButton Variant="Variant.Filled" Color="@MudBlazor.Color.Primary"
					StartIcon="@Icons.Material.Filled.Search" OnClick="LoadLogs">
					搜索
				</MudButton>
			</MudStack>

			<MudDivider Class="my-4" />

			@* 日志列表区域 *@
			<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="@MudBlazor.AlignItems.Center" Class="mb-3">
				<MudText Typo="Typo.h5">
					<MudIcon Icon="@Icons.Material.Filled.List" Size="@MudBlazor.Size.Small" Class="mr-2" />
					日志列表
					@if (totalCount > 0)
					{
						<MudChip T="string" Size="@MudBlazor.Size.Small" Color="@MudBlazor.Color.Primary" Class="ml-2">共
							@totalCount 条</MudChip>
					}
				</MudText>
				<MudButton Variant="Variant.Outlined" Size="@MudBlazor.Size.Small" Color="@MudBlazor.Color.Primary"
					StartIcon="@Icons.Material.Filled.Refresh" OnClick="LoadLogs"
					Disabled="@(refreshCooldownSeconds > 0 || isLoading)">
					@GetRefreshButtonText()
				</MudButton>
			</MudStack>

			@if (isLoading)
			{
				<MudProgressLinear Color="@MudBlazor.Color.Primary" Indeterminate="true" Class="my-2" />
				<MudText Class="text-center py-4">加载中...</MudText>
			}
			else if (logs == null || !logs.Any())
			{
				<MudAlert Severity="Severity.Info" Class="mt-3">
					<MudIcon Icon="@Icons.Material.Filled.Info" Size="@MudBlazor.Size.Small" Class="mr-2" />
					暂无日志数据
				</MudAlert>
			}
			else
			{
				<MudDataGrid Items="@logs" Hover="true" Striped="true" Dense="true" ReadOnly="true"
					FilterMode="@MudBlazor.DataGridFilterMode.Simple" Class="mt-3" NoDataContent="暂无数据" Loading="@isLoading"
					HideFooter="true">
					<Columns>
						<PropertyColumn Property="@(x => x.Timestamp)" Title="时间" Format="yyyy-MM-dd HH:mm:ss"
							Sortable="true" />
						<PropertyColumn Property="@(x => x.Level)" Title="级别" Sortable="true">
							<CellTemplate>
								<MudChip T="string" Size="@MudBlazor.Size.Small" Color="@GetLevelColor(context.Item.Level)">
									@context.Item.Level</MudChip>
							</CellTemplate>
						</PropertyColumn>
						<PropertyColumn Property="@(x => x.Message)" Title="消息" Sortable="false">
							<CellTemplate>
								<MudTooltip Text="@context.Item.Message">
									<MudText
										Style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
										@context.Item.Message
									</MudText>
								</MudTooltip>
							</CellTemplate>
						</PropertyColumn>
						<PropertyColumn Property="@(x => x.OccurrenceCount)" Title="出现次数" Sortable="true">
							<CellTemplate>
								@if (context.Item.OccurrenceCount > 1)
								{
									<MudChip T="string" Size="@MudBlazor.Size.Small" Color="@MudBlazor.Color.Warning">
										@context.Item.OccurrenceCount 次</MudChip>
								}
								else
								{
									<MudText>-</MudText>
								}
							</CellTemplate>
						</PropertyColumn>
						<TemplateColumn Title="操作" Sortable="false">
							<CellTemplate>
								<MudButton Variant="Variant.Text" Size="@MudBlazor.Size.Small" Color="@MudBlazor.Color.Info"
									StartIcon="@Icons.Material.Filled.Visibility"
									OnClick="() => ShowLogDetail(context.Item)">
									详情
								</MudButton>
							</CellTemplate>
						</TemplateColumn>
					</Columns>
				</MudDataGrid>

				@* 自定义分页（因为 MudDataGrid 的分页需要服务器端分页支持） *@
				<MudStack Row="true" Justify="@MudBlazor.Justify.Center" Class="mt-4">
					<MudPagination Count="@totalPages" Selected="@currentPage"
						SelectedChanged="@((int page) => ChangePage(page))" BoundaryCount="2" MiddleCount="2" />
				</MudStack>
			}
		</MudCardContent>
	</MudCard>
</MudContainer>
