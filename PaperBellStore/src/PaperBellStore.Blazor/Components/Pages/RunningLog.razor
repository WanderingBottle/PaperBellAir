@page "/running-log"
@using PaperBellStore.Blazor.Services
@using PaperBellStore.Blazor.Components
@using PaperBellStore.Data
@using System.Globalization
@using Blazorise
@using Blazorise.Components
@using Blazorise.DataGrid
@inherits BreadcrumbComponentBase
@implements IAsyncDisposable

<PageTitle>运行日志</PageTitle>

<PageBreadcrumb BreadcrumbId="@BreadcrumbId" HomeMenu="@HomeMenu" ParentMenu="@ParentMenu" CurrentMenu="@CurrentMenu" />

<div class="mt-2" style="width: 100%; max-width: 100%; padding: 0 15px; overflow-x: hidden; box-sizing: border-box;">
	@* 过滤和搜索区域 *@
	<h5 class="mb-4">
		<Icon Name="IconName.Filter" Size="IconSize.Small" Class="mr-2" />
		过滤和搜索
	</h5>

	<Row>
		<Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnTablet.Is3.OnDesktop">
			<Field>
				<FieldLabel>日志级别</FieldLabel>
				<Select TValue="string" SelectedValue="selectedLevel"
					SelectedValueChanged="@((string value) => selectedLevel = value)">
					<SelectItem TValue="string" Value="@((string?)null)">全部</SelectItem>
					<SelectItem TValue="string" Value="@("Verbose")">Verbose</SelectItem>
					<SelectItem TValue="string" Value="@("Debug")">Debug</SelectItem>
					<SelectItem TValue="string" Value="@("Information")">Information</SelectItem>
					<SelectItem TValue="string" Value="@("Warning")">Warning</SelectItem>
					<SelectItem TValue="string" Value="@("Error")">Error</SelectItem>
					<SelectItem TValue="string" Value="@("Fatal")">Fatal</SelectItem>
				</Select>
			</Field>
		</Column>
		<Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnTablet.Is3.OnDesktop">
			<Field>
				<FieldLabel>开始日期</FieldLabel>
				<DateEdit @bind-Date="startDate" />
			</Field>
		</Column>
		<Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnTablet.Is3.OnDesktop">
			<Field>
				<FieldLabel>结束日期</FieldLabel>
				<DateEdit @bind-Date="endDate" />
			</Field>
		</Column>
		<Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnTablet.Is3.OnDesktop">
			<Field>
				<FieldLabel>搜索消息</FieldLabel>
				<div class="search-input-wrapper">
					<TextEdit @bind-Text="searchText" Placeholder="搜索日志消息..." Class="search-input" />
					<Icon Name="IconName.Search" Class="search-input-icon" />
				</div>
			</Field>
		</Column>
	</Row>

	<Row JustifyContent="JustifyContent.Between" AlignItems="AlignItems.Center" Class="mt-3">
		<Column ColumnSize="ColumnSize.IsAuto">
			<Row>
				<Column ColumnSize="ColumnSize.IsAuto" Class="pr-2">
					<Button Color="Color.Secondary" Clicked="ResetFilters">
						<Icon Name="IconName.Sync" />
						重置过滤
					</Button>
				</Column>
				<Column ColumnSize="ColumnSize.IsAuto">
					<Button Color="Color.Primary" Clicked="LoadLogs">
						<Icon Name="IconName.Search" />
						搜索
					</Button>
				</Column>
			</Row>
		</Column>
		<Column ColumnSize="ColumnSize.IsAuto">
			<Button Color="Color.Primary" Clicked="LoadLogs" Disabled="@(refreshCooldownSeconds > 0 || isLoading)">
				<Icon Name="IconName.Sync" />
				@GetRefreshButtonText()
			</Button>
		</Column>
	</Row>

	<Divider Class="my-4" />

	@* 日志列表区域 *@
	<Row JustifyContent="JustifyContent.Between" AlignItems="AlignItems.Center" Class="mb-3">
		<Column ColumnSize="ColumnSize.IsAuto">
			<h5>
				<Icon Name="IconName.List" Size="IconSize.Small" Class="mr-2" />
				日志列表
				@if (totalCount > 0)
				{
					<Badge Color="Color.Primary" Pill="true" Class="ml-2">共 @totalCount 条</Badge>
				}
			</h5>
		</Column>
	</Row>

	<DataGrid TItem="AppLog" @ref="dataGrid" Data="@logItems" ReadData="@OnReadData" TotalItems="@totalCount"
		Hoverable="true" Striped="true" ShowPager="true" PageSize="20" Class="mt-3" Style="width: 100%; table-layout: fixed;">
		<EmptyTemplate>
			<Text>暂无数据</Text>
		</EmptyTemplate>
		<DataGridColumns>
			<DataGridColumn TItem="AppLog" Field="@nameof(AppLog.Timestamp)" Caption="时间" Sortable="true" Width="140px">
				<DisplayTemplate>
					<Text Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@context.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</Text>
				</DisplayTemplate>
			</DataGridColumn>
			<DataGridColumn TItem="AppLog" Field="@nameof(AppLog.Level)" Caption="级别" Sortable="true" Width="100px">
				<DisplayTemplate>
					<Badge Color="@GetLevelColor(context.Level)">
						@context.Level
					</Badge>
				</DisplayTemplate>
			</DataGridColumn>
			<DataGridColumn TItem="AppLog" Field="@nameof(AppLog.Message)" Caption="消息" Width="calc(100% - 520px)">
				<DisplayTemplate>
					<Tooltip Text="@context.Message">
						<Text Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; max-width: 100%;">
							@context.Message
						</Text>
					</Tooltip>
				</DisplayTemplate>
			</DataGridColumn>
			<DataGridColumn TItem="AppLog" Field="@nameof(AppLog.OccurrenceCount)" Caption="出现次数" Sortable="true"
				Width="100px">
				<DisplayTemplate>
					@if (context.OccurrenceCount > 1)
					{
						<Badge Color="Color.Warning" Pill="true">
							@context.OccurrenceCount 次
						</Badge>
					}
					else
					{
						<Text>-</Text>
					}
				</DisplayTemplate>
			</DataGridColumn>
			<DataGridColumn TItem="AppLog" Caption="操作" Sortable="false" Width="120px">
				<DisplayTemplate>
					<Button Color="Color.Info" Size="Size.Small" Clicked="@(() => ShowLogDetail(context))">
						<Icon Name="IconName.Eye" />
						详情
					</Button>
				</DisplayTemplate>
			</DataGridColumn>
		</DataGridColumns>
	</DataGrid>
</div>
