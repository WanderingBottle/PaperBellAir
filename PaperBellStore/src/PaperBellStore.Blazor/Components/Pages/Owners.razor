@page "/owners"
@using Microsoft.Extensions.Localization
@using ProjectManage.Owners
@using ProjectManage.Localization
@using PaperBellStore.Localization
@using Volo.Abp.Application.Dtos
@using System.Threading
@using System.Linq
@using MudBlazor
@using MudBlazor.Extensions
@using Microsoft.AspNetCore.Components
@using PaperBellStore.Blazor.Components
@using PaperBellStore.Blazor.Menus
@inject IOwnerAppService OwnerAppService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IStringLocalizer<ProjectManageResource> ProjectL
@inject IStringLocalizer<PaperBellStoreResource> L
@rendermode InteractiveServer
@inherits BreadcrumbComponentBase

<PageBreadcrumb BreadcrumbId="@BreadcrumbId" HomeMenu="@HomeMenu" ParentMenu="@ParentMenu" CurrentMenu="@CurrentMenu" />

<div class="pa-4">
	<MudText Typo="Typo.h5" GutterBottom="true">负责人列表</MudText>

	<MudStack Spacing="2" Class="mb-4">
		<MudStack Row="true" Spacing="2" Justify="Justify.SpaceBetween" AlignItems="AlignItems.End">
			<MudStack Row="true" Spacing="2" AlignItems="AlignItems.End">
				@if (_searchMode == SearchMode.Fuzzy)
				{
					<MudTextField @bind-Value="_search" Placeholder="搜索负责人（匹配编码、名称、描述、邮箱、电话）..." Adornment="Adornment.Start"
						AdornmentIcon="@Icons.Material.Filled.Search" Immediate="false" Class="search-field"
						Style="min-width: 300px;" />
				}
				<MudSelect Value="_searchMode" ValueChanged="@((SearchMode mode) => OnSearchModeChanged(mode))"
					Label="查询模式" Dense="true" Style="min-width: 120px;">
					<MudSelectItem Value="@SearchMode.Fuzzy">模糊查询</MudSelectItem>
					<MudSelectItem Value="@SearchMode.Exact">精确查询</MudSelectItem>
				</MudSelect>
				<MudButton Color="MudBlazor.Color.Info" Variant="Variant.Outlined" OnClick="OnSearchChanged"
					StartIcon="@Icons.Material.Filled.Search">
					搜索
				</MudButton>
				<MudButton Color="MudBlazor.Color.Default" Variant="Variant.Text" OnClick="ClearSearch"
					StartIcon="@Icons.Material.Filled.Clear">
					清除
				</MudButton>
			</MudStack>
			<MudStack Row="true" Spacing="2">
				<MudButton Color="MudBlazor.Color.Info" Variant="Variant.Outlined" OnClick="RefreshData"
					StartIcon="@Icons.Material.Filled.Refresh">
					刷新
				</MudButton>
				<MudButton Color="MudBlazor.Color.Success" Variant="Variant.Outlined" OnClick="ExportToExcelAsync"
					StartIcon="@Icons.Material.Filled.FileDownload">
					导出Excel
				</MudButton>
				<MudButton Color="MudBlazor.Color.Info" Variant="Variant.Outlined" OnClick="DownloadTemplateAsync"
					StartIcon="@Icons.Material.Filled.Download">
					下载模板
				</MudButton>
				<MudButton Color="MudBlazor.Color.Warning" Variant="Variant.Outlined" OnClick="ShowImportDialogAsync"
					StartIcon="@Icons.Material.Filled.FileUpload">
					导入Excel
				</MudButton>
				<MudButton Color="MudBlazor.Color.Primary" Variant="Variant.Filled" OnClick="ShowAddDialogAsync"
					StartIcon="@Icons.Material.Filled.Add">
					新增负责人
				</MudButton>
			</MudStack>
		</MudStack>

		@if (_searchMode == SearchMode.Exact)
		{
			<MudPaper Elevation="1" Class="pa-4">
				<MudText Typo="Typo.subtitle2" GutterBottom="true">精确查询条件</MudText>
				<MudGrid>
					<MudItem xs="12" sm="6" md="4">
						<MudTextField @bind-Value="_exactSearch.Code" Label="负责人编码" Variant="Variant.Outlined"
							Dense="true" />
					</MudItem>
					<MudItem xs="12" sm="6" md="4">
						<MudTextField @bind-Value="_exactSearch.Name" Label="负责人名称" Variant="Variant.Outlined"
							Dense="true" />
					</MudItem>
					<MudItem xs="12" sm="6" md="4">
						<MudTextField @bind-Value="_exactSearch.Description" Label="描述" Variant="Variant.Outlined"
							Dense="true" />
					</MudItem>
					<MudItem xs="12" sm="6" md="4">
						<MudTextField @bind-Value="_exactSearch.Email" Label="邮箱" Variant="Variant.Outlined" Dense="true" />
					</MudItem>
					<MudItem xs="12" sm="6" md="4">
						<MudTextField @bind-Value="_exactSearch.Phone" Label="电话" Variant="Variant.Outlined" Dense="true" />
					</MudItem>
					<MudItem xs="12" sm="6" md="4">
						<MudSelect @bind-Value="_exactSearch.Department" Label="部门" Variant="Variant.Outlined" Dense="true"
							Clearable="true">
							<MudSelectItem Value="@((OwnerDepartment?)null)">全部</MudSelectItem>
							<MudSelectItem Value="@((OwnerDepartment?)OwnerDepartment.ResearchAndDevelopment)">研发部
							</MudSelectItem>
							<MudSelectItem Value="@((OwnerDepartment?)OwnerDepartment.Implementation)">实施部</MudSelectItem>
							<MudSelectItem Value="@((OwnerDepartment?)OwnerDepartment.Project)">项目部</MudSelectItem>
						</MudSelect>
					</MudItem>
				</MudGrid>
			</MudPaper>
		}
	</MudStack>

	<MudDataGrid T="OwnerDto" @ref="_dataGrid" ServerData="@LoadServerData"
		FilterMode="@MudBlazor.DataGridFilterMode.Simple" SortMode="@MudBlazor.SortMode.Multiple" Hover="true"
		Bordered="true" Striped="true" Elevation="2" Class="mt-2">
		<Columns>
			<PropertyColumn Property="@(x => x.Code)" Title="负责人编码" Sortable="true" Filterable="true" />
			<PropertyColumn Property="@(x => x.Name)" Title="负责人名称" Sortable="true" Filterable="true" />
			<PropertyColumn Property="@(x => x.Description)" Title="描述" Sortable="true" Filterable="true">
				<CellTemplate>
					@(string.IsNullOrEmpty(context.Item.Description) ? "-" : context.Item.Description)
				</CellTemplate>
			</PropertyColumn>
			<PropertyColumn Property="@(x => x.Email)" Title="邮箱" Sortable="true" Filterable="true">
				<CellTemplate>
					@(string.IsNullOrEmpty(context.Item.Email) ? "-" : context.Item.Email)
				</CellTemplate>
			</PropertyColumn>
			<PropertyColumn Property="@(x => x.Phone)" Title="电话" Sortable="true" Filterable="true">
				<CellTemplate>
					@(string.IsNullOrEmpty(context.Item.Phone) ? "-" : context.Item.Phone)
				</CellTemplate>
			</PropertyColumn>
			<TemplateColumn Title="部门" Sortable="true" SortBy="@(x => x.Department.ToString())">
				<CellTemplate>
					<MudChip Size="MudBlazor.Size.Small" Color="@GetDepartmentColor(context.Item.Department)">
						@GetDepartmentText(context.Item.Department)
					</MudChip>
				</CellTemplate>
			</TemplateColumn>
			<TemplateColumn Title="操作" Sortable="false" Filterable="false">
				<CellTemplate>
					<MudStack Row="true" Spacing="1">
						<MudButton Variant="Variant.Text" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Primary"
							OnClick="@(() => ShowEditDialogAsync(context.Item))"
							StartIcon="@Icons.Material.Filled.Edit">
							编辑
						</MudButton>
						<MudButton Variant="Variant.Text" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Error"
							OnClick="@(() => ShowDeleteConfirmDialog(context.Item))"
							StartIcon="@Icons.Material.Filled.Delete">
							删除
						</MudButton>
					</MudStack>
				</CellTemplate>
			</TemplateColumn>
		</Columns>
		<PagerContent>
			<MudDataGridPager T="OwnerDto" />
		</PagerContent>
	</MudDataGrid>
</div>

@code {
	private MudDataGrid<OwnerDto> _dataGrid;
	private List<OwnerDto> _owners = new();
	private string _search = string.Empty;
	private SearchMode _searchMode = SearchMode.Fuzzy;
	private ExactSearchModel _exactSearch = new();

	protected override string BreadcrumbId => "owner-breadcrumb";
	protected override string CurrentPagePath => "/owners";
	protected override string[] MenuItemPaths => new[] { PaperBellStoreMenus.Home, "ProjectManagement",
"ProjectManagement.Owners" };

	private enum SearchMode
	{
		Fuzzy, // 模糊查询
		Exact // 精确查询
	}

	private class ExactSearchModel
	{
		public string Code { get; set; }
		public string Name { get; set; }
		public string Description { get; set; }
		public string Email { get; set; }
		public string Phone { get; set; }
		public OwnerDepartment? Department { get; set; }
	}

	private async Task OnSearchModeChanged(SearchMode mode)
	{
		_searchMode = mode;
		await InvokeAsync(StateHasChanged);
	}

	private async Task OnSearchChanged()
	{
		await RefreshData();
	}

	private async Task ClearSearch()
	{
		if (_searchMode == SearchMode.Fuzzy)
		{
			_search = string.Empty;
		}
		else
		{
			_exactSearch = new ExactSearchModel();
		}
		await RefreshData();
	}

	private async Task<MudBlazor.GridData<OwnerDto>> LoadServerData(MudBlazor.GridState<OwnerDto> state)
	{
		var req = new GetOwnerListDto
		{
			SkipCount = state.Page * state.PageSize,
			MaxResultCount = state.PageSize,
			Sorting = BuildSorting(state)
		};

		// 根据查询模式设置查询条件
		if (_searchMode == SearchMode.Fuzzy)
		{
			// 模糊查询：使用Filter字段匹配Code、Name、Description、Email和Phone
			req.Filter = string.IsNullOrWhiteSpace(_search) ? null : _search;
		}
		else
		{
			// 精确查询：设置各个字段的精确查询条件
			req.Code = string.IsNullOrWhiteSpace(_exactSearch.Code) ? null : _exactSearch.Code;
			req.Name = string.IsNullOrWhiteSpace(_exactSearch.Name) ? null : _exactSearch.Name;
			req.Description = string.IsNullOrWhiteSpace(_exactSearch.Description) ? null : _exactSearch.Description;
			req.Email = string.IsNullOrWhiteSpace(_exactSearch.Email) ? null : _exactSearch.Email;
			req.Phone = string.IsNullOrWhiteSpace(_exactSearch.Phone) ? null : _exactSearch.Phone;
			req.Department = _exactSearch.Department;
		}

		var result = await OwnerAppService.GetListAsync(req);
		_owners = result.Items.ToList();

		return new MudBlazor.GridData<OwnerDto>
		{
			Items = _owners,
			TotalItems = (int)result.TotalCount
		};
	}

	private string BuildSorting(MudBlazor.GridState<OwnerDto> state)
	{
		if (state.SortDefinitions == null || !state.SortDefinitions.Any())
		{
			return "CreationTime DESC";
		}

		var sortParts = state.SortDefinitions.Select(s =>
		$"{s.SortBy} {(s.Descending ? "DESC" : "ASC")}"
		);

		return string.Join(", ", sortParts);
	}

	private async Task ShowAddDialogAsync()
	{
		var editing = new CreateUpdateOwnerDto { Department = OwnerDepartment.ResearchAndDevelopment };
		var parameters = new DialogParameters
		{
			[nameof(OwnerDialog.Model)] = editing,
			[nameof(OwnerDialog.IsEdit)] = false
		};

		var options = new DialogOptions
		{
			CloseOnEscapeKey = true,
			MaxWidth = MaxWidth.Medium,
			FullWidth = true
		};

		var dialog = await DialogService.ShowAsync<OwnerDialog>("新增负责人", parameters, options);
		var result = await dialog.Result;

		if (result != null && !result.Canceled && result.Data != null)
		{
			if (result.Data is OwnerDialog.OwnerDialogResult dialogResult)
			{
				await OwnerAppService.CreateAsync(dialogResult.Model);
				Snackbar.Add("创建成功", Severity.Success);
				await RefreshData();
			}
		}
	}

	private async Task ShowEditDialogAsync(OwnerDto dto)
	{
		var editing = new CreateUpdateOwnerDto
		{
			Name = dto.Name,
			Description = dto.Description,
			Email = dto.Email,
			Phone = dto.Phone,
			Department = dto.Department
		};

		var parameters = new DialogParameters
		{
			[nameof(OwnerDialog.Model)] = editing,
			[nameof(OwnerDialog.IsEdit)] = true,
			[nameof(OwnerDialog.OwnerId)] = dto.Id
		};

		var options = new DialogOptions
		{
			CloseOnEscapeKey = true,
			MaxWidth = MaxWidth.Medium,
			FullWidth = true
		};

		var dialog = await DialogService.ShowAsync<OwnerDialog>("编辑负责人", parameters, options);
		var result = await dialog.Result;

		if (result != null && !result.Canceled && result.Data != null)
		{
			if (result.Data is OwnerDialog.OwnerDialogResult dialogResult)
			{
				await OwnerAppService.UpdateAsync(dto.Id, dialogResult.Model);
				Snackbar.Add("更新成功", Severity.Success);
				await RefreshData();
			}
		}
	}

	private async Task ShowDeleteConfirmDialog(OwnerDto owner)
	{
		var parameters = new DialogParameters
		{
			[nameof(SimpleDialog.ContentText)] = $"确定要删除负责人 '{owner.Name}' 吗？此操作无法撤销。",
			[nameof(SimpleDialog.ButtonText)] = "删除",
			[nameof(SimpleDialog.ButtonColor)] = MudBlazor.Color.Error
		};

		var options = new DialogOptions
		{
			CloseOnEscapeKey = true,
			MaxWidth = MaxWidth.Small,
			FullWidth = true
		};

		var dialog = await DialogService.ShowAsync<SimpleDialog>("确认删除", parameters, options);
		var result = await dialog.Result;

		if (result != null && !result.Canceled)
		{
			await Delete(owner.Id);
		}
	}

	private async Task Delete(Guid id)
	{
		try
		{
			await OwnerAppService.DeleteAsync(id);
			Snackbar.Add("删除成功", Severity.Success);
			await RefreshData();
		}
		catch (Exception ex)
		{
			Snackbar.Add($"删除失败: {ex.Message}", Severity.Error);
		}
	}

	private async Task RefreshData()
	{
		if (_dataGrid != null)
		{
			await _dataGrid.ReloadServerData();
		}
		await InvokeAsync(StateHasChanged);
	}

	private async Task ExportToExcelAsync()
	{
		try
		{
			var fileBytes = await OwnerAppService.ExportToExcelAsync();
			var fileName = $"负责人数据_{DateTime.Now:yyyyMMddHHmmss}.xlsx";

			await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileBytes));
			Snackbar.Add("导出成功", Severity.Success);
		}
		catch (Exception ex)
		{
			Snackbar.Add($"导出失败: {ex.Message}", Severity.Error);
		}
	}

	private async Task ShowImportDialogAsync()
	{
		var parameters = new DialogParameters
		{
			[nameof(ImportExcelDialog.OnImport)] = new EventCallback<byte[]>(this, ImportFromExcelAsync)
		};

		var options = new DialogOptions
		{
			CloseOnEscapeKey = true,
			MaxWidth = MaxWidth.Medium,
			FullWidth = true
		};

		await DialogService.ShowAsync<ImportExcelDialog>("导入Excel", parameters, options);
	}

	private async Task ImportFromExcelAsync(byte[] fileContent)
	{
		try
		{
			await OwnerAppService.ImportFromExcelAsync(fileContent);
			Snackbar.Add("导入成功", Severity.Success);
			await RefreshData();
		}
		catch (Exception ex)
		{
			Snackbar.Add($"导入失败: {ex.Message}", Severity.Error);
		}
	}

	private async Task DownloadTemplateAsync()
	{
		try
		{
			var fileBytes = await OwnerAppService.ExportTemplateAsync();
			var fileName = $"负责人导入模板.xlsx";

			await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileBytes));
			Snackbar.Add("模板下载成功", Severity.Success);
		}
		catch (Exception ex)
		{
			Snackbar.Add($"模板下载失败: {ex.Message}", Severity.Error);
		}
	}

	private MudBlazor.Color GetDepartmentColor(OwnerDepartment department)
	{
		return department switch
		{
			OwnerDepartment.ResearchAndDevelopment => MudBlazor.Color.Info,
			OwnerDepartment.Implementation => MudBlazor.Color.Success,
			OwnerDepartment.Project => MudBlazor.Color.Warning,
			_ => MudBlazor.Color.Default
		};
	}

	private string GetDepartmentText(OwnerDepartment department)
	{
		return department switch
		{
			OwnerDepartment.ResearchAndDevelopment => "研发部",
			OwnerDepartment.Implementation => "实施部",
			OwnerDepartment.Project => "项目部",
			_ => department.ToString()
		};
	}

}
