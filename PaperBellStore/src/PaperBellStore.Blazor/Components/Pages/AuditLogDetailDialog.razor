@using MudBlazor
@using Volo.Abp.AuditLogging

<MudDialog>
	<TitleContent>
		<MudText Typo="Typo.h6">审计日志详情</MudText>
	</TitleContent>
	<DialogContent>
		<MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true">
			<MudTabPanel Text="基本信息">
				<MudGrid Spacing="3" Class="mt-2">
					<MudItem xs="12" sm="6">
						<MudText><strong>执行时间:</strong> @AuditLog.ExecutionTime.ToString("yyyy-MM-dd HH:mm:ss.fff")
						</MudText>
					</MudItem>
					<MudItem xs="12" sm="6">
						<MudText><strong>执行时长:</strong> @AuditLog.ExecutionDuration ms</MudText>
					</MudItem>
					<MudItem xs="12" sm="6">
						<MudText><strong>用户名:</strong> @(AuditLog.UserName ?? "-")</MudText>
					</MudItem>
					<MudItem xs="12" sm="6">
						<MudText><strong>租户名称:</strong> @(AuditLog.TenantName ?? "-")</MudText>
					</MudItem>
					<MudItem xs="12" sm="6">
						<MudText><strong>客户端IP:</strong> @(AuditLog.ClientIpAddress ?? "-")</MudText>
					</MudItem>
					<MudItem xs="12" sm="6">
						<MudText><strong>客户端名称:</strong> @(AuditLog.ClientName ?? "-")</MudText>
					</MudItem>
					<MudItem xs="12" sm="6">
						<MudText><strong>关联ID:</strong> @(AuditLog.CorrelationId ?? "-")</MudText>
					</MudItem>
					<MudItem xs="12" sm="6">
						<MudText><strong>应用名称:</strong> @(AuditLog.ApplicationName ?? "-")</MudText>
					</MudItem>
				</MudGrid>
			</MudTabPanel>

			<MudTabPanel Text="HTTP请求信息">
				<MudGrid Spacing="3" Class="mt-2">
					<MudItem xs="12" sm="6">
						<MudText><strong>HTTP方法:</strong></MudText>
						@if (!string.IsNullOrEmpty(AuditLog.HttpMethod))
						{
							<MudChip T="string" Size="@MudBlazor.Size.Small" Color="@MudBlazor.Color.Secondary"
								Class="ml-2">
								@AuditLog.HttpMethod</MudChip>
						}
						else
						{
							<MudText Class="ml-2">-</MudText>
						}
					</MudItem>
					<MudItem xs="12" sm="6">
						<MudText><strong>HTTP状态码:</strong></MudText>
						@if (AuditLog.HttpStatusCode.HasValue)
						{
							<MudChip T="string" Size="@MudBlazor.Size.Small"
								Color="@GetStatusCodeColor(AuditLog.HttpStatusCode.Value)" Class="ml-2">
								@AuditLog.HttpStatusCode.Value</MudChip>
						}
						else
						{
							<MudText Class="ml-2">-</MudText>
						}
					</MudItem>
					<MudItem xs="12">
						<MudText><strong>URL:</strong></MudText>
						<MudPaper Elevation="0" Class="pa-2 mt-1" Style="background-color: #f5f5f5;">
							<MudText Style="word-wrap: break-word; margin: 0; font-family: monospace;">@(AuditLog.Url ??
																"-")</MudText>
						</MudPaper>
					</MudItem>
					<MudItem xs="12">
						<MudText><strong>浏览器信息:</strong></MudText>
						<MudPaper Elevation="0" Class="pa-2 mt-1" Style="background-color: #f5f5f5;">
							<MudText Style="word-wrap: break-word; margin: 0;">@(AuditLog.BrowserInfo ?? "-")</MudText>
						</MudPaper>
					</MudItem>
					@if (!string.IsNullOrEmpty(AuditLog.Comments))
					{
						<MudItem xs="12">
							<MudText><strong>备注:</strong></MudText>
							<MudPaper Elevation="0" Class="pa-2 mt-1" Style="background-color: #f5f5f5;">
								<MudText Style="word-wrap: break-word; margin: 0;">@AuditLog.Comments</MudText>
							</MudPaper>
						</MudItem>
					}
				</MudGrid>
			</MudTabPanel>

			<MudTabPanel Text="异常信息">
				@if (!string.IsNullOrEmpty(AuditLog.Exceptions))
				{
					<MudPaper Elevation="0" Class="pa-3 mt-2"
						Style="max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 0.9em; background-color: #fff3cd;">
						<MudText Style="white-space: pre-wrap; word-wrap: break-word; margin: 0; color: #856404;">
							@AuditLog.Exceptions
						</MudText>
					</MudPaper>
				}
				else
				{
					<MudAlert Severity="Severity.Info" Class="mt-2">
						<MudIcon Icon="@Icons.Material.Filled.Info" Size="@MudBlazor.Size.Small" Class="mr-2" />
						无异常信息
					</MudAlert>
				}
			</MudTabPanel>

			<MudTabPanel Text="操作列表">
				@if (FilteredActions != null && FilteredActions.Any())
				{
					<MudDataGrid Items="@FilteredActions" Hover="true" Striped="true" Dense="true" ReadOnly="true"
						FilterMode="@MudBlazor.DataGridFilterMode.Simple" NoDataContent="暂无操作数据" HideFooter="true"
						Class="mt-2">
						<Columns>
							<TemplateColumn Title="系统标签" Sortable="false">
								<CellTemplate>
									@if (IsSystemOperation(context.Item.ServiceName))
									{
										<MudChip T="string" Size="@MudBlazor.Size.Small" Color="@MudBlazor.Color.Dark"
											Variant="Variant.Outlined">
											<MudIcon Icon="@Icons.Material.Filled.Computer" Size="@MudBlazor.Size.Small"
												Class="mr-1" />
											系统
										</MudChip>
									}
									else
									{
										<MudText>-</MudText>
									}
								</CellTemplate>
							</TemplateColumn>
							<PropertyColumn Property="@(x => x.ServiceName)" Title="服务名称" Sortable="true">
								<CellTemplate>
									<MudText Style="font-family: monospace; font-size: 0.9em;">@context.Item.ServiceName
									</MudText>
								</CellTemplate>
							</PropertyColumn>
							<PropertyColumn Property="@(x => x.MethodName)" Title="方法名称" Sortable="true">
								<CellTemplate>
									<MudText Style="font-family: monospace; font-size: 0.9em;">@context.Item.MethodName
									</MudText>
								</CellTemplate>
							</PropertyColumn>
							<PropertyColumn Property="@(x => x.ExecutionTime)" Title="执行时间" Format="yyyy-MM-dd HH:mm:ss.fff"
								Sortable="true" />
							<PropertyColumn Property="@(x => x.ExecutionDuration)" Title="执行时长(ms)" Sortable="true" />
							<TemplateColumn Title="参数" Sortable="false">
								<CellTemplate>
									@if (!string.IsNullOrEmpty(context.Item.Parameters))
									{
										<MudExpansionPanels Elevation="0" MultiExpansion="false">
											<MudExpansionPanel Text="查看参数" Icon="@Icons.Material.Filled.Code">
												<MudPaper Elevation="0" Class="pa-2"
													Style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.85em; background-color: #f5f5f5;">
													<MudText Style="white-space: pre-wrap; word-wrap: break-word; margin: 0;">
														@FormatJson(context.Item.Parameters)
													</MudText>
												</MudPaper>
											</MudExpansionPanel>
										</MudExpansionPanels>
									}
									else
									{
										<MudText>-</MudText>
									}
								</CellTemplate>
							</TemplateColumn>
						</Columns>
					</MudDataGrid>
				}
				else
				{
					<MudAlert Severity="Severity.Info" Class="mt-2">
						<MudIcon Icon="@Icons.Material.Filled.Info" Size="@MudBlazor.Size.Small" Class="mr-2" />
						无操作记录
					</MudAlert>
				}
			</MudTabPanel>
		</MudTabs>
	</DialogContent>
	<DialogActions>
		<MudButton OnClick="Cancel">关闭</MudButton>
	</DialogActions>
</MudDialog>

@code {
	[CascadingParameter] IMudDialogInstance? MudDialog { get; set; }

	[Parameter]
	public Volo.Abp.AuditLogging.AuditLog AuditLog { get; set; } = default!;

	[Parameter]
	public List<Volo.Abp.AuditLogging.AuditLogAction>? Actions { get; set; }

	/// <summary>
	/// 过滤后的操作列表（排除 Volo.Abp 相关的操作）
	/// </summary>
	private List<Volo.Abp.AuditLogging.AuditLogAction>? FilteredActions =>
	Actions?.Where(x => x.ServiceName == null || !x.ServiceName.Contains("Volo.Abp")).ToList();

	/// <summary>
	/// 判断是否为系统操作
	/// </summary>
	private bool IsSystemOperation(string? serviceName)
	{
		if (string.IsNullOrEmpty(serviceName))
			return false;

		var systemKeywords = new[] { "System", "Microsoft", "Internal", "Framework" };
		return systemKeywords.Any(keyword =>
		serviceName.Contains(keyword, StringComparison.OrdinalIgnoreCase));
	}

	private void Cancel()
	{
		MudDialog?.Cancel();
	}

	private MudBlazor.Color GetStatusCodeColor(int statusCode)
	{
		return statusCode switch
		{
			>= 200 and < 300 => MudBlazor.Color.Success, // 2xx
			>= 300 and < 400 => MudBlazor.Color.Info, // 3xx
			>= 400 and < 500 => MudBlazor.Color.Warning, // 4xx
			>= 500 => MudBlazor.Color.Error, // 5xx
			_ => MudBlazor.Color.Default
		};
	}

	private string FormatJson(string? json)
	{
		if (string.IsNullOrEmpty(json))
			return string.Empty;

		try
		{
			var jsonObj = System.Text.Json.JsonSerializer.Deserialize<object>(json);
			return System.Text.Json.JsonSerializer.Serialize(jsonObj, new System.Text.Json.JsonSerializerOptions
			{
				WriteIndented = true
			});
		}
		catch
		{
			return json;
		}
	}
}
